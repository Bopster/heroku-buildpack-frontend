#!/bin/sh
# bin/compile <build-dir> <cache-dir> <env-dir>
### Configure directories

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

### Set methods and vars used in script

indent() {
    sed -u 's/^/       /'
}

PREFIX="----->"

## Start compiling

# Restore node cache dir
echo "$PREFIX Start restoring NodeJS Buildpack cache node_modules dir"
mkdir -p $(dirname "$BUILD_DIR/node_modules")
cp -r "$CACHE_DIR/node/node_modules" "$BUILD_DIR"

# Get into build dir
cd $BUILD_DIR

# Install bower
echo "$PREFIX Setup environment for bower"

if [ ! -f "$BUILD_DIR/node_modules/.bin/bower" ]; then
    echo "Install bower" | indent
    npm install bower >/dev/null
fi

echo "Run 'bower install'" | indent
$BUILD_DIR/node_modules/.bin/bower install | indent

# Install gulp locally
echo "$PREFIX Running gulp"

$BUILD_DIR/node_modules/.bin/gulp | indent

echo "$PREFIX Checking if ./dist directory is present"

if [ ! -d "$BUILD_DIR/dist" ]; then
    echo "No ./dist directory found. This should be present by now, exiting." | indent
    exit 1
else
    echo "./dist Directory found, build done." | indent
fi

# Do cleanup
echo "$PREFIX Start cleanup to keep slug size small"

if [ -d "$BUILD_DIR/bower_components" ]; then
    echo "removing bower_components directory." | indent
    rm -r $BUILD_DIR/bower_components
fi

if [ -d "$BUILD_DIR/src" ]; then
    echo "removing src directory." | indent
    rm -r $BUILD_DIR/src
fi