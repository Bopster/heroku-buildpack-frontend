#!/bin/sh
# bin/compile <build-dir> <cache-dir> <env-dir>
### Configure directories

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

### Set methods and vars used in script

indent() {
    sed -u 's/^/       /'
}

PREFIX="----->"

## Start compiling

# Restore node cache dir
echo "$PREFIX Start restoring NodeJS Buildpack cache node_modules dir"
mkdir -p $(dirname "$BUILD_DIR/node_modules")
mv "$CACHE_DIR/node/$cachepath" "$BUILD_DIR/node_modules"

# Get into build dir
cd $BUILD_DIR

# Install all npm dev dependencies
echo "$PREFIX Installing all npm packages"
npm install --quit >/dev/null

# Install bower
echo "$PREFIX Setup environment for bower"

if [ ! -f "$BUILD_DIR/node_modules/.bin/bower" ]; then
    echo "Install bower" | indent
    npm install bower >/dev/null
fi

echo "Run 'bower install'" | indent
$BUILD_DIR/node_modules/.bin/bower install | indent

# Install gulp locally
echo "$PREFIX Running gulp"

$BUILD_DIR/node_modules/.bin/gulp | indent

echo "$PREFIX Checking if ./dist directory is present"

if [ ! -d "$BUILD_DIR/dist" ]; then
    echo "No ./dist directory found. This should be present by now, exiting." | indent
    exit 1
else
    echo "./dist Directory found, build done." | indent
fi