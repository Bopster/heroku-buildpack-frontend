#!/bin/sh
# bin/compile <build-dir> <cache-dir> <env-dir>
### Configure directories

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

### Set methods and vars used in script

indent() {
    sed -u 's/^/       /'
}

PREFIX="----->"

restore_cache_directories() {
  local build_dir=${1:-}
  local cache_dir=${2:-}

  for cachepath in ${@:3}; do
    if [ -e "$build_dir/$cachepath" ]; then
      echo "- $cachepath (exists - skipping)"
    else
      if [ -e "$cache_dir/node/$cachepath" ]; then
        echo "- $cachepath"
        mkdir -p $(dirname "$build_dir/$cachepath")
        mv "$cache_dir/node/$cachepath" "$build_dir/$cachepath"
      else
        echo "- $cachepath (not cached - skipping)"
      fi
    fi
  done
}

## Start compiling

# Restore node cache dir
echo "$PREFIX Start restoring NodeJS Buildpack cache node_modules dir"
mkdir -p $(dirname "$BUILD_DIR/node_modules")
mv "$CACHE_DIR/node/$cachepath" "$BUILD_DIR/node_modules"

# Install all npm dev dependencies
echo "$PREFIX Installing all npm packages"
npm install --quit >/dev/null

# Install bower
echo "$PREFIX Setup environment for bower"

if [ ! -f "$BUILD_DIR/node_modules/.bin/bower" ]; then
    echo "Install bower" | indent
    npm install bower >/dev/null
fi

echo "Run 'bower install'" | indent
$BUILD_DIR/node_modules/.bin/bower install | indent

# Install gulp locally
echo "$PREFIX Running gulp"

$CACHE_DIR/node_modules/.bin/gulp | indent

echo "$PREFIX Checking if ./dir directory is present"

if [ ! -d "$BUILD_DIR/dir" ]; then
    echo "No ./dir directory found. This should be present by now, exiting." | indent
    exit 1
else
    echo "./dir Directory found, build done." | indent
fi